<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>لوحة التحكم - العميل</title>
<link rel="stylesheet" href="style.css">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<!-- EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<script>
  // تهيئة Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAzH6gqMdbxKhoZwkWwfJuuopElNRU2JsU",
    authDomain: "alotebi-3500c.firebaseapp.com",
    projectId: "alotebi-3500c",
    storageBucket: "alotebi-3500c.appspot.com",
    messagingSenderId: "99457641243",
    appId: "1:99457641243:web:b9e86295f64e4f652b81be",
    measurementId: "G-HQF5V5FY2L"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // تهيئة EmailJS
  (function(){
    emailjs.init('n-emjquApVgXAj-iE'); // Public Key
  })();
</script>
</head>
<body>

<div class="header container">
  <div class="logo">⚖️ <span class="lawyer-name">مكتب المحامي محمد العتيبي</span></div>
  <div class="nav">
    <a href="#home">الرئيسية</a>
    <a href="#about">من نحن</a>
    <a href="#services">خدماتنا</a>
    <a href="#cases">قصص نجاح</a>
    <a href="#contact">تواصل</a>
    <a href="#" id="logoutBtn">تسجيل خروج</a>
  </div>
  <div class="menu-toggle">☰</div>
</div>

<main class="container">
  <section class="glass">
    <h2>لوحة التحكم - معلومات العميل</h2>
    <div id="clientInfo">
      <p><strong>الاسم:</strong> <span id="clientName"></span></p>
      <p><strong>البريد الإلكتروني:</strong> <span id="clientEmail"></span></p>
      <p><strong>رقم الهوية:</strong> <span id="clientId"></span></p>
      <p><strong>المبلغ / القضية:</strong> <span id="clientAmount"></span></p>
      <p><strong>الحالة:</strong> <span id="clientStatus"></span></p>
    </div>

    <h3>رفع مستند</h3>
    <form id="uploadForm">
      <input type="text" id="message" placeholder="اكتب رسالة أو ملاحظات" required>
      <input type="file" id="fileInput" required>
      <button type="submit">إرسال المستند</button>
    </form>
    <p id="formMsg" style="color:green"></p>
  </section>
</main>

<footer class="container" style="text-align:center;padding:24px 0;color:rgba(255,255,255,0.6)">
  © 2025 مكتب المحامي محمد العتيبي
</footer>

<script src="script.js"></script>
<script>
const menuToggle = document.querySelector('.menu-toggle');
const nav = document.querySelector('.nav');
menuToggle.addEventListener('click', () => nav.classList.toggle('show-nav'));

// التأكد من تسجيل الدخول
auth.onAuthStateChanged(async user => {
  if (!user) {
    window.location.href = 'login.html';
    return;
  }

  // جلب بيانات العميل من Firestore
  const doc = await db.collection('clients').doc(user.uid).get();
  if (!doc.exists) {
    alert('لم يتم العثور على بياناتك.');
    return;
  }

  const data = doc.data();
  document.getElementById('clientName').innerText = data.name;
  document.getElementById('clientEmail').innerText = data.email;
  document.getElementById('clientId').innerText = data.idNumber;
  document.getElementById('clientAmount').innerText = data.amount;
  document.getElementById('clientStatus').innerText = data.status;
});

// تسجيل خروج
document.getElementById('logoutBtn').addEventListener('click', e => {
  e.preventDefault();
  auth.signOut().then(() => {
    window.location.href = 'login.html';
  });
});

// فورم رفع الملفات عبر EmailJS
const uploadForm = document.getElementById('uploadForm');
const formMsg = document.getElementById('formMsg');

uploadForm.addEventListener('submit', async e => {
  e.preventDefault();
  const name = document.getElementById('clientName').innerText;
  const email = document.getElementById('clientEmail').innerText;
  const idNumber = document.getElementById('clientId').innerText;
  const amount = document.getElementById('clientAmount').innerText;
  const message = document.getElementById('message').value;
  const fileInput = document.getElementById('fileInput');

  if (fileInput.files.length === 0) {
    formMsg.style.color = 'red';
    formMsg.innerText = 'يرجى اختيار ملف';
    return;
  }

  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onload = function() {
    const base64File = reader.result;

    const templateParams = {
      name, email, idNumber, amount, message,
      fileName: file.name,
      fileContent: base64File
    };

    emailjs.send('service_k0kn04w','template_72zpvuq', templateParams)
      .then(() => {
        formMsg.style.color = 'green';
        formMsg.innerText = 'تم إرسال المستند بنجاح!';
        uploadForm.reset();
      })
      .catch(err => {
        console.error(err);
        formMsg.style.color = 'red';
        formMsg.innerText = 'حدث خطأ أثناء إرسال المستند';
      });
  };
  reader.readAsDataURL(file);
});
</script>

</body>
</html>
